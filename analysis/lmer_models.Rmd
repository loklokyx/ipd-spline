---
title: "Models in lmer package"
author: "Lok Yiu Xuan [23171563]"
date: "`r format(Sys.Date(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(splines)
library(rms)
library(lme4)
library(ggplot2)
source("../scripts/helpers.R")
```

# Read Data
```{r}
myfunc <- "10 + 5 * (1 + exp((.15 * (X1 - 60))))^(-1)"
true_data <- tibble(X1 = seq(20, 100, length.out = 200)) %>%
  mutate(Y = eval(parse(text = myfunc)))

ipd_data <- read_csv("../data/generated_ipd.csv") %>%
  mutate(Study = as.factor(Study))

nrow(ipd_data)
```
```{r}
noise_sd <- 2
set.seed(10)
ipd_data <- ipd_data %>%
  mutate(Y = Y + rnorm(n(), mean = 0, sd = noise_sd))

dd <- datadist(ipd_data)
options(datadist = "dd")
```
# Stage 1
## Fit study-specific spline models
```{r}
studies <- unique(ipd_data$Study)
study_models <- setNames(lapply(studies, function(s) {
  study_data <- subset(ipd_data, Study == s)
  
  quan <- make_quantiles(study_data$Age, 3)
  pred_str <- make_rcs_formula("Age", quan)
  formula_obj <- as.formula(paste0("Y ~ ", pred_str))
  model <- ols(formula_obj, data = study_data)
  
  list(
    study = s,
    formula = formula_obj,
    data = study_data,
    model = model,
    fitted = fitted(model),
    residuals = residuals(model)
  )
}), studies)
```
## Predictions per study
```{r}
pred_ori_data <- do.call(rbind, lapply(study_models, function(sm) {
  data.frame(
    study = sm$study,
    Age   = sm$data$Age,
    Y     = predict(sm$model, newdata = sm$data)
  )
}))
head(pred_ori_data)
```
# Stage 2
```{r}
lmer_data <- pred_ori_data
pred_str <- make_rcs_formula("Age", make_quantiles(lmer_data$Age, 5))
lmer_formula <- as.formula(paste0("Y ~ ", pred_str, "+ (1 | study)"))
lmer_model <- lmer(lmer_formula, data = lmer_data)
lmer_data$pred_null <- predict(lmer_model, newdata = lmer_data, re.form = NULL)
lmer_data$pred_study <- predict(lmer_model, newdata = lmer_data, re.form = ~(1 | study))
lmer_data$pred_NA <- predict(lmer_model, newdata = lmer_data, re.form = NA)
lmer_data$pred_0 <- predict(lmer_model, newdata = lmer_data, re.form = ~0)
plot_data <- lmer_data %>%
  select(study, Age, pred_null, pred_study, pred_NA, pred_0) %>%
  pivot_longer(cols = starts_with("pred"),
               names_to = "Prediction_Type",
               values_to = "Predicted")
```

## Method 2: random effect
```{r}
ggplot(plot_data, aes(x = Age, y = Predicted, color = Prediction_Type)) +
  geom_point(alpha = 0.6) +
  geom_line(data = true_data, aes(x = X1, y = Y), color = "black", linewidth = 1) +
  facet_wrap(~Prediction_Type, scales = "fixed") +
  labs(title = "Comparison of Predictions by re.form",
       x = "Age", y = "Predicted Y")
```

