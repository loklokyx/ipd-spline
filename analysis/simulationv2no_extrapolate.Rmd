---
title: "Simulation Extrapolation Analysis Version 2"
author: "Lok Yiu Xuan [23171563]"
date: "`r format(Sys.Date(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(rms)
library(patchwork)
source("../scripts/helpers.R")
```
# Read Settings
```{r}
file_dir <- "../data/extrapolate/simulated_no/"
simul_settings <- read_csv(paste0(file_dir, "simul_settings.csv"), show_col_types = FALSE)
# Exclude same knots file
study_cols <- grep("^Study", names(simul_settings), value = TRUE)
# Apply filter
# simul_settings <- simul_settings[!apply(simul_settings, 1, is_same_knots), ]
```

```{r}
ggplot(simul_settings, aes(x=Rank_pooled, y=Rank_meta)) +geom_point()
```




```{r}
exclude_cols <- c("Stage2", 
                  grep("^MSE", names(simul_settings), value = TRUE), 
                  grep("^Study", names(simul_settings), value = TRUE), 
                  grep("^Rank_", names(simul_settings), value = TRUE))

top_n <- 10
worst_n <- 10
rank_all <- make_rank_all(simul_settings, top_n, worst_n)

rank_cols <- grep("^Rank_", names(simul_settings), value = TRUE)
# Factor with desired order
methods <- unique(rank_all$rank_method)
lvls <- c(paste0("top", 1:top_n), paste0("worst", worst_n:1))
rank_all %>% dplyr::select(-all_of(exclude_cols))
```
# Read Simulation Data
```{r}
sim_data_no <- list()
for (i in 1:nrow(rank_all)) {
  df_row <- rank_all[i,]
  filename <- paste0(file_dir, df_row$Name, ".csv")
  sim_df <- read_csv(filename, show_col_types = FALSE)
  stage2_knots_str <- df_row$Stage2

  sim_data_no[[i]] <- sim_df %>%
    mutate(
      stage2_quantiles_str = stage2_knots_str,
      stage2_knots = length(knots_to_numeric(stage2_knots_str)),
      study_knots = word(df_row$Name, 1, sep = "_"),
      rank_method = df_row$rank_method,
      rank_id = df_row$rank_id
    )
}
names(sim_data_no) <- rank_all$Name
```
```{r}
ggplot(sim_data_no[[1]]) +
  geom_point(aes(x = Age, y = Y, color = as.factor(Study)), shape=1) +
  labs(title = "Simulated True Data (No Overlap)", x = "Age", y = "Y",
       color = "Study")
  # facet_wrap(~Study, scales = "fixed")
```
# Calculate Metrics Reduce df
```{r}
all_metrics_no <- lapply(sim_data_no, function(df) {
  lapply(methods, function(m) {
    df_filtered <- df %>% filter(method == m)
    calculate_metrics(df_filtered, level = 0.95) %>%
      mutate(method = m)
  }) %>% bind_rows()
})
```
# Summary of all
```{r}
metrics <- c("mse", "variance", "bias")
# Apply summary to all_metrics_no
summary_all_no <- set_summary(all_metrics_no, metrics = metrics)
summary_all_no %>% arrange(method, rank_id)
```
# Bias, Variance, MSE plot
```{r}
df_all_no <- bind_rows(all_metrics_no)
df_plot_no <- df_all_no %>%
  filter(
    method == rank_method
  ) %>%
  mutate(
    line_id = paste0(method, "_", study_knots),
    rank_id = factor(rank_id, levels = lvls)  # enforce order
  ) %>%
  pivot_longer(
    cols = all_of(metrics),
    names_to = "metric_name",
    values_to = "metric_value"
  )
```

### line plot
```{r, fig.width=10}
plots_no <- lapply(metrics, function(m) base_plot(df_plot_no, m, 
                                                  ncol=2, legend_ncol=4))
# plots_no
```
```{r, fig.width=14}
plots_no <- lapply(metrics, function(m) base_plot(df_plot_no, m, 
                                                  ncol=5, legend_ncol=10))
# wrap_plots(
#   list(plots_no[[1]], plots_no[[2]], plots_no[[3]]),
#   ncol=3,
# )
plots_no[[1]]
plots_no[[2]]
plots_no[[3]]
```
### CI True Value
```{r, fig.width=12}
plot_CI_no <- base_plot_CI(df_plot_no, ncol = 2, legend_ncol = 4,
                           jitter_height = 0, show_jitter = T)
plot_CI_no
```