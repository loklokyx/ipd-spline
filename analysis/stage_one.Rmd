---
title: "stage one"
author: "Lok Yiu Xuan [23171563]"
date: "2025-07-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(splines)
```

# Read Data
```{r}
ipd_data <- read_csv("../data/generated_ipd.csv")
model_preds <- c("Age^2")
preds <- c("Age")
# glimpse(ipd_data)
# summary(ipd_data)
nrow(ipd_data)
```
# fit splines
## stage 1 (3 df for natural splines)
```{r}
stage1_results <- fit_study_splines(ipd_data, outcome = "Y", 
                                    predictors = model_preds, 
                                    df_splines = 4)
```

# Extract and summarize results
```{r}
# stage1_results
summary_df <- tibble()
for (result in stage1_results) {
    study_id <- result$study
    study_result <- stage1_results[[toString(study_id)]]
    
    for (model_name in names(study_result$models)) {
      model_info <- study_result$models[[model_name]]
      
      # Extract key statistics
      r_squared <- model_info$summary$r.squared
      adj_r_squared <- model_info$summary$adj.r.squared
      rmse <- sqrt(mean(model_info$residuals^2))
      
      summary_df <- bind_rows(summary_df, tibble(
        study = study_id,
        model = model_name,
        predictor = model_info$predictor,
        n = study_result$sample_size,
        r_squared = r_squared,
        adj_r_squared = adj_r_squared,
        rmse = rmse
      ))
    }
  }
  
```


```{r}
# Get summary of stage 1 results
stage1_summary <- extract_stage1_summary(stage1_results)
stage1_summary
```

# Plot

```{r}
ipd_data$Study <- as.factor(ipd_data$Study)
stage1_results <- fit_study_splines(ipd_data, outcome = "Y", 
                                    predictors = preds,
                                    df_splines = 4)
plots <- create_all_spline_plots(stage1_results, ipd_data, preds = preds, ncol=2)
```

```{r, fig.height=5}
plots[["Age"]]
```

```{r}
stage1_results[[1]]$models$Age$summary
```
```{r}
ipd_data[ipd_data$Y<=1,]
```

```{r}
compares = list(c("1","2"), c("3","4"), c("5","6"))
for (i in seq_along(compares)) {
  compare <- compares[[i]]

  stage1_results2 <- setNames(
    lapply(compare, function(id) stage1_results[[id]]),
    compare
  )
  ipd_data2 <- ipd_data %>% filter(Study %in% compare)
  plots2 <- create_all_spline_plots(stage1_results2, ipd_data2, preds = preds, ncol = 2)
  print(plots2$Age$splines)
}
```


# func
```{r}
fit_study_splines <- function(data, outcome = "Y", predictors = c(), methods = c("ns"), df_splines = 3) {
  
  # Initialize list to store results
  study_results <- list()
  studies <- unique(data$Study)
  
  for (s in studies) {
    study_data <- data %>% filter(Study == s)
    # Fit spline models for each predictor
    spline_models <- list()
    for (method in methods){
      for (pred in predictors) {
        # Natural splines model
        formula_str <- paste0(outcome, " ~ ", method,"(", pred, ", df = ", df_splines, ")")
        # Evaluate formula first
        formula_obj <- as.formula(formula_str)

        # Fit the model
        model <- lm(formula_obj, data = study_data)
        
        spline_models[[pred]] <- list(
          predictor = pred,
          study = s,
          model = model,
          formula_obj = formula_str,
          summary = summary(model),
          fitted_values = fitted(model),
          residuals = residuals(model)
        )
      }
    }
    
    study_results[[toString(s)]] <- list(
      study = s,
      data = study_data,
      models = spline_models,
      sample_size = nrow(study_data)
    )
  }
  
  return(study_results)
}

extract_stage1_summary <- function(results) {
  summary_df <- tibble()
  
  for (result in results) {
    study_id <- result$study
    study_result <- results[[toString(study_id)]]
    
    for (model_name in names(study_result$models)) {
      model_info <- study_result$models[[model_name]]
      
      # Extract key statistics
      r_squared <- model_info$summary$r.squared
      adj_r_squared <- model_info$summary$adj.r.squared
      rmse <- sqrt(mean(model_info$residuals^2))
      
      summary_df <- bind_rows(summary_df, tibble(
        study = study_id,
        model = model_name,
        predictor = model_info$predictor,
        n = study_result$sample_size,
        r_squared = r_squared,
        adj_r_squared = adj_r_squared,
        rmse = rmse
      ))
    }
  }
  
  return(summary_df)
}

create_single_spline_plot <- function(results, ipd_data, pred, ncol = 3) {
  residuals_data <- tibble()
  plots <- list()

  # Get variable names from the formula string
  vars <- unique(unlist(str_split(pred, "\\+|\\*|:")))
  vars <- trimws(vars)

  for (var_to_vary in vars) {
    spline_data <- tibble()

    for (result in results) {
      study_id <- result$study
      study_data <- results[[toString(study_id)]]$data
      model_info <- results[[toString(study_id)]]$models[[pred]]
      model <- model_info$model

      # Build prediction data: vary var_to_vary, fix others
      pred_range <- seq(min(study_data[[var_to_vary]]), max(study_data[[var_to_vary]]), length.out = 100)

      # Get all variables in the model (excluding response)
      predictors <- all.vars(formula(model))[-1]

      # Build newdata
      new_data <- map_dfc(predictors, function(var) {
        if (var == var_to_vary) {
          tibble(!!var := pred_range)
        } else {
          tibble(!!var := mean(study_data[[var]], na.rm = TRUE))
        }
      })

      predictions <- predict(model, newdata = new_data)

      spline_data <- bind_rows(spline_data, tibble(
        study = study_id,
        x = pred_range,
        predicted_Y = predictions
      ))

      # Collect residuals
      residuals_data <- bind_rows(residuals_data, tibble(
        study = study_id,
        fitted = model_info$fitted_values,
        residuals = model_info$residuals
      ))
    }

    # Spline plot for this var_to_vary
    spline_plot <- ggplot() +
      geom_point(data = ipd_data, aes_string(x = var_to_vary, y = "Y", color = "Study"), alpha = 0.7, size = 2) +
      geom_line(data = spline_data, aes(x = x, y = predicted_Y, color = study), size = 1.2) +
      facet_wrap(~study, scales = "free", ncol = ncol) +
      labs(
        title = paste("Stage 1: Spline for", pred, "-", var_to_vary, "by Study"),
        x = var_to_vary,
        y = "Y"
      ) +
      theme_minimal() +
      theme(legend.position = "bottom")

    plots[[var_to_vary]] <- spline_plot
  }

  # Residuals plot (single per model)
  residual_plot <- residuals_data %>%
    ggplot(aes(x = fitted, y = residuals)) +
    geom_point(alpha = 0.6) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    geom_smooth(se = FALSE, color = "blue") +
    facet_wrap(~study, scales = "free_x", ncol = ncol) +
    labs(
      title = paste("Stage 1: Residuals vs Fitted (", pred, ")"),
      x = "Fitted Values",
      y = "Residuals"
    ) +
    theme_minimal()

  return(list(
    splines = plots,
    residuals = residual_plot
  ))
}

create_all_spline_plots <- function(results, ipd_data, preds = c(), ncol = 3) {
  plots <- list()

  for (pred in preds) {
    single_plots <- create_single_spline_plot(results, ipd_data, pred, ncol)
    
    # Store by predictor name
    plots[[pred]] <- single_plots
  }

  return(plots)
}
```
