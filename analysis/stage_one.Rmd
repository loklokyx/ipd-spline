---
title: "stage one"
author: "Lok Yiu Xuan [23171563]"
date: "2025-07-03"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(splines)
library(rms)
```

# Read Data
```{r}
ipd_data <- read_csv("../data/generated_ipd.csv")
ipd_data$Study <- as.factor(ipd_data$Study)
model_preds <- c(make_rcs(ipd_data$Age, knots=5))
preds <- c("Age")
# glimpse(ipd_data)
# summary(ipd_data)
nrow(ipd_data)
```
# fit splines
## stage 1
```{r}
stage1_results <- fit_study_splines(ipd_data, outcome = "Y",
                                    predictors = model_preds)
```

# Extract and summarize results
```{r}
# Get summary of stage 1 results
stage1_summary <- extract_stage1_summary(stage1_results)
stage1_summary
```

# Plot

```{r}
plots <- create_all_spline_plots(stage1_results, ipd_data, preds = model_preds, vary_var = "Age", ncol=2)
```

```{r, fig.height=5}
plots$`rcs(Age, c(2.7, 14.4, 22.6, 30.6, 70.2))`
```

```{r}
compares = list(c("1","2"), c("3","4"), c("5","6"))
desired = model_preds[1]
for (i in seq_along(compares)) {
  compare <- compares[[i]]

  stage1_results2 <- setNames(
    lapply(compare, function(id) stage1_results[[id]]),
    compare
  )
  ipd_data2 <- ipd_data %>% filter(Study %in% compare)
  plots2 <- create_all_spline_plots(stage1_results2, ipd_data2, preds = model_preds, vary_var = "Age", ncol = 2)
  print(plots2[[desired]]$splines)
}
```

# func
```{r}
dd <- datadist(ipd_data)
options(datadist = "dd")

make_rcs <- function(x, knots = NULL, n = NULL, dp = 1) {
  # Extract variable name (last part after $)
  var_name <- tail(strsplit(deparse(substitute(x)), "\\$")[[1]], 1)
  
  quan <- list(
    '3' = c(0.10, 0.50, 0.90),
    '4' = c(0.05, 0.35, 0.65, 0.95),
    '5' = c(0.05, 0.275, 0.50, 0.725, 0.95),
    '6' = c(0.05, 0.23, 0.41, 0.59, 0.77, 0.95),
    '7' = c(0.025, 0.1833, 0.3417, 0.50, 0.6583, 0.8167, 0.975)
  )
  
  if (!is.null(n)) {
    knot_str <- paste(n, collapse = ", ")
    return(sprintf("rcs(%s, %s)", var_name, knot_str))
  }
  
  if (!is.null(knots)) {
    preset_str <- as.character(knots)
    if (preset_str %in% names(quan)) {
      knot_values <- quantile(x, probs = quan[[preset_str]], na.rm = TRUE)
      knot_str <- paste(round(knot_values, dp), collapse = ", ")
      return(sprintf("rcs(%s, c(%s))", var_name, knot_str))
    }
  }
  
  return(sprintf("rcs(%s)", var_name))
}

fit_study_splines <- function(data, outcome = "Y", predictors = c()) {
  study_results <- list()
  studies <- unique(data$Study)


  for (s in studies) {
    study_data <- filter(data, Study == s)
    spline_models <- list()
    
    for (pred in predictors) {
      formula_obj <- as.formula(paste0(outcome, " ~ ", pred))
      model <- ols(formula_obj, data = study_data)
      
      spline_models[[pred]] <- list(
        predictor = pred,
        study = s,
        model = model,
        fitted_values = fitted(model),
        residuals = residuals(model)
      )
    }
    
    study_results[[as.character(s)]] <- list(
      study = s,
      data = study_data,
      models = spline_models,
      sample_size = nrow(study_data)
    )
  }
  
  return(study_results)
}

extract_stage1_summary <- function(results) {
  summary_df <- tibble()
  
  for (result in results) {
    study_id <- result$study
    study_result <- results[[toString(study_id)]]
    
    for (model_name in names(study_result$models)) {
      model_info <- study_result$models[[model_name]]
      
      # Extract key statistics
      r_squared <- model_info$summary$r.squared
      adj_r_squared <- model_info$summary$adj.r.squared
      rmse <- sqrt(mean(model_info$residuals^2))
      
      summary_df <- bind_rows(summary_df, tibble(
        study = study_id,
        predictor = model_info$predictor,
        n = study_result$sample_size,
        r_squared = r_squared,
        adj_r_squared = adj_r_squared,
        rmse = rmse
      ))
    }
  }
  
  return(summary_df)
}

create_single_spline_plot <- function(results, ipd_data, pred, vary_var, ncol = 3) {
  residuals_data <- tibble()
  spline_data <- tibble()

  for (result in results) {
    study_id <- result$study
    study_data <- results[[toString(study_id)]]$data
    model_info <- results[[toString(study_id)]]$models[[pred]]
    model <- model_info$model
    
    # Range for the variable to vary
    pred_range <- seq(
      min(study_data[[vary_var]], na.rm = TRUE),
      max(study_data[[vary_var]], na.rm = TRUE),
      length.out = 100
    )
    all_vars = names(study_data)
    # Build newdata: vary only vary_var, fix others at mean
    new_data <- map_dfc(all_vars, function(var) {
      val <- if (var == vary_var) {
        pred_range
      } else if (is.numeric(study_data[[var]])) {
        mean(study_data[[var]], na.rm = TRUE)
      } else {
        names(sort(table(study_data[[var]]), decreasing = TRUE))[1]  # mode
      }
      tibble(!!var := val)
    })

    predictions <- predict(model, newdata = new_data)

    spline_data <- bind_rows(spline_data, tibble(
      study = study_id,
      x = pred_range,
      predicted_Y = predictions
    ))

    residuals_data <- bind_rows(residuals_data, tibble(
      study = study_id,
      fitted = model_info$fitted_values,
      residuals = model_info$residuals
    ))
  }

  spline_plot <- ggplot() +
    geom_point(
      data = ipd_data,
      aes_string(x = vary_var, y = "Y", color = "Study"),
      alpha = 0.7, size = 2
    ) +
    geom_line(
      data = spline_data,
      aes(x = x, y = predicted_Y, color = study),
      size = 1.2
    ) +
    facet_wrap(~study, scales = "free", ncol = ncol) +
    labs(
      title = paste("Stage 1: Spline for", vary_var, "by Study"),
      x = vary_var,
      y = "Y"
    ) +
    theme_minimal() +
    theme(legend.position = "bottom")

  residual_plot <- residuals_data %>%
    ggplot(aes(x = fitted, y = residuals)) +
    geom_point(alpha = 0.6) +
    geom_hline(yintercept = 0, linetype = "dashed", color = "red") +
    geom_smooth(se = FALSE, color = "blue") +
    facet_wrap(~study, scales = "free_x", ncol = ncol) +
    labs(
      title = paste("Stage 1: Residuals vs Fitted (", pred, ")"),
      x = "Fitted Values",
      y = "Residuals"
    ) +
    theme_minimal()

  return(list(
    splines = spline_plot,
    residuals = residual_plot
  ))
}

create_all_spline_plots <- function(results, ipd_data, preds = c(), vary_var, ncol = 3) {
  plots <- list()
  filtered_preds <- preds[grepl(vary_var, preds)]
  for (pred in filtered_preds) {
    single_plots <- create_single_spline_plot(results, ipd_data, pred, vary_var, ncol)
    
    # Store by predictor name
    plots[[pred]] <- single_plots
  }

  return(plots)
}
```
