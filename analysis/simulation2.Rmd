---
title: "Simulation Analysis"
author: "Lok Yiu Xuan [23171563]"
date: "`r format(Sys.Date(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(tidyr)
library(patchwork)
library(metafor)
```
# Read Simulation Data
```{r}
files2 <- list(
  simul_knots3 = "../data/simul_knots3.csv", 
  simul_knots4 = "../data/simul_knots4.csv", 
  simul_knots5 = "../data/simul_knots5.csv"
)
sim_data2 <- lapply(files2, read_csv, show_col_types = FALSE)
```
# Calculate Metrics Reduce df
```{r}
calculate2_metrics <- function(df, level = 0.95) {
  # identify simulation columns
  sim_cols <- grep("^sim_", names(df), value = TRUE)
  Y_true <- df$Y
  
  alpha <- 1 - level
  z_val <- qnorm(1 - alpha / 2)
  
  # extract simulation matrix for easier computation
  sim_matrix <- as.matrix(df[, sim_cols])
  row_means <- rowMeans(sim_matrix)
  row_vars <- apply(sim_matrix, 1, var)
  row_mses <- rowMeans((sim_matrix - Y_true)^2)

  tibble(
    Age = df$Age,
    Y_true = Y_true,
    bias = row_means - Y_true,
    variance = row_vars,
    mse = row_mses,
    mean_pred = row_means,
    residual = Y_true - row_means,
    lower_ci = row_means - z_val * sqrt(row_vars),
    upper_ci = row_means + z_val * sqrt(row_vars),
    method = df$method,
    knots = df$knots
  )
}

metrics2_list <- lapply(sim_data2, calculate2_metrics, level = 0.95)
```
# Summary of all
```{r}
metrics <- c("bias", "variance", "mse")
summ_2 <- set_summary(metrics2_list, metrics = metrics)
# reorder columns
summ_2 <- summ_2 %>%
  select(method, knots, everything())
summ_2
```
# Bias, Variance, MSE plot
## n=1800
### line plot
```{r, fig.height=10, fig.width=7}
df2_all <- bind_rows(metrics2_list) %>%
  pivot_longer(cols = c("bias", "variance", "mse"),
               names_to = "metric_name",
               values_to = "metric_value")
df2_all$itr <- interaction(df2_all$method, df2_all$knots)

# idx <- df2_all$method != 'meta_re'
# df2_all <- df2_all[idx,]

ggplot(df2_all, aes(x = Age, y = metric_value, color = method, group = itr)) +
  geom_point(size = 1) +
  # geom_line(size = 1) +
  facet_grid(metric_name ~ knots) +
  theme_minimal() +
  labs(x = "Age", y = "Value", fill = "Base Method", color = "Method") +
  theme(
    legend.position = "bottom",
    panel.spacing = unit(1, "lines"),
    strip.background = element_rect(fill = "white")
  )
```
### CI True Value
```{r, fig.height=12, fig.width=5}
ggplot(df2_all, aes(x = Age, y = mean_pred, color = method, fill = method, group = itr)) +
  geom_point(size = 1) +
  # geom_line(size = 1) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.2, color = NA) +
  geom_line(aes(y = Y_true), color = "black", linetype = "dashed") +
  facet_wrap(~knots, ncol = 1, scales = "free_y") +
  theme_minimal() +
  labs(
    x = "Age",
    y = "Predicted Y",
    color = "Method",
    fill = "Method",
    title = "Predicted Values with Confidence Intervals by Knots"
  ) +
  theme(
    legend.position = "bottom",
    panel.spacing = unit(1.5, "lines"),
    strip.background = element_rect(fill = "white")
  )
```

```{r}

```

