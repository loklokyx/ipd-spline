---
title: "Simulation Analysis Version 2"
author: "Lok Yiu Xuan [23171563]"
date: "`r format(Sys.Date(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(tidyr)
library(patchwork)
library(metafor)
```
# Read Settings
```{r}
file_dir <- "../data/simulated_many/"
simul_settings <- read_csv(paste0(file_dir, "simul_settings.csv"), show_col_types = FALSE)
```
```{r}
knots_to_numeric <- function(knots_str) {
  # Handle NA or empty string
  if (is.na(knots_str) || knots_str == "") {
    return(c(0))
  }
  # Split by comma, trim whitespace, and convert to numeric
  as.numeric(trimws(unlist(strsplit(knots_str, ","))))
}

# Exclude same knots file
study_cols <- grep("^Study", names(simul_settings), value = TRUE)

# Function to check if Stage2 == all Study columns
is_same_knots <- function(row) {
  all(sapply(study_cols, function(c){
    length(knots_to_numeric(row[[c]])) == length(knots_to_numeric(row[["Stage2"]]))
  }))
}
# Apply filter
simul_settings <- simul_settings[!apply(simul_settings, 1, is_same_knots), ]
```

```{r}
rank_cols <- grep("^Rank_", names(simul_settings), value = TRUE)
methods <- sub("^Rank_", "", rank_cols)

exclude_cols <- c("Stage2", 
                  grep("^MSE", names(simul_settings), value = TRUE),
                  grep("^Study", names(simul_settings), value = TRUE),
                  grep("^Rank_", names(simul_settings), value = TRUE))

top <- 3
top_all <- lapply(rank_cols, function(col) {
  simul_settings %>%
    arrange(.data[[col]]) %>%
    slice(1:top) %>%
    mutate(rank_method = sub("^Rank_", "", col),
           rank_id = row_number())
}) %>%
  bind_rows()

top_all %>% select(-all_of(exclude_cols))
```
# Read Simulation Data
```{r}
sim_data_many <- list()
for (i in 1:nrow(top_all)) {
  df_row <- top_all[i,]
  filename <- paste0(file_dir, df_row$Name, ".csv")
  sim_df <- read_csv(filename, show_col_types = FALSE)
  stage2_knots_str <- df_row$Stage2

  sim_data_many[[i]] <- sim_df %>%
    mutate(
      stage2_quantiles_str = stage2_knots_str,
      stage2_knots = length(knots_to_numeric(stage2_knots_str)),
      study_knots = word(df_row$Name, 1, sep = "_"),
      rank_method = df_row$rank_method,
      rank_id = df_row$rank_id
    )
}
names(sim_data_many) <- top_all$Name
```
```{r}
plot(Y~Age, col=Study, data=sim_data_many[[1]])
```

# Calculate Metrics Reduce df
```{r}
all_metrics_many <- lapply(sim_data_many, function(df) {
  lapply(methods, function(m) {
    df_filtered <- df %>% filter(method == m)
    calculate_metrics(df_filtered, level = 0.95) %>%
      mutate(method = m)
  }) %>% bind_rows()
})
```
# Summary of all
```{r}
# Apply summary to all_metrics_many
summary_all <- set_summary(all_metrics_many, metrics = c("mse", "variance", "bias"))
summary_all
```
# Bias, Variance, MSE plot
## n=1800
### line plot
```{r, fig.height=10, fig.width=7}
df_all <- bind_rows(all_metrics_many)

# Filter only top rank (rank_id == 1) and method matches rank_method
df_plot <- df_all %>%
  filter(rank_id %in% 1:top, method == rank_method) %>%
  mutate(line_id = paste0(method, "_", study_knots)) %>%  # new identifier
  pivot_longer(
    cols = c("bias", "variance", "mse"),
    names_to = "metric_name",
    values_to = "metric_value"
  )

# Split into three data frames
df_rank1 <- df_plot %>% filter(rank_id == 1)
df_rank2 <- df_plot %>% filter(rank_id == 2)
df_rank3 <- df_plot %>% filter(rank_id == 3)

quantiles_numeric <- knots_to_numeric(df_plot$stage2_quantiles_str[1])

# Plot
# ggplot(df_plot, aes(x = Age, y = metric_value, color = line_id)) +
#   geom_line(size = 1) +
#   geom_vline(
#     xintercept = quantiles_numeric,
#     linetype = "dashed", color = "grey40"
#   ) +
#  # rows = metric_name, cols = rank_id +
# # facet_grid(metric_name ~ rank_id, scales = "free_y") +
# # facet_wrap(~metric_name, scales = "free", ncol = 1) +
#   theme_minimal() +
#   labs(
#     x = "Age",
#     y = "Value",
#     color = "Ranked Method"
#   ) +
#   theme(
#     legend.position = "bottom",
#     panel.spacing = unit(1, "lines"),
#     strip.background = element_rect(fill = "white"),
#     panel.grid.major.x = element_line(color = "grey80"),  # grid for quantiles
#     panel.grid.minor.x = element_blank()
#   )
```
```{r}
# Generate plots
p1 <- base_plot(df_rank1) + ggtitle("Rank ID: 1")
p2 <- base_plot(df_rank2) + ggtitle("Rank ID: 2")
p3 <- base_plot(df_rank3) + ggtitle("Rank ID: 3")

# List of plots
list(p1, p2, p3)
```


### CI True Value
```{r, fig.height=7, fig.width=5}
# ggplot(df_plot, aes(x = Age, y = mean_pred, color = method, fill = method, group)) +
#   geom_line(size = 1) +
#   geom_vline(
#     xintercept = quantiles_numeric, 
#     linetype = "dashed", color = "grey40") +
#   geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.2, color = NA) +
#   geom_line(aes(y = Y_true), color = "black", linetype = "dashed") +
#   # facet_wrap(~study_knots, ncol = 1) +
#   theme_minimal() +
#   labs(
#     x = "Age",
#     y = "Predicted Y",
#     color = "Method",
#     fill = "Method",
#     title = "Predicted Values with Confidence Intervals by Knots"
#   ) +
#   theme(
#     legend.position = "bottom",
#     panel.spacing = unit(1.5, "lines"),
#     strip.background = element_rect(fill = "white")
#   )
```
```{r}
# Generate plots
p1 <- base_plot_CI(df_rank1) + ggtitle("Rank ID: 1")
p2 <- base_plot_CI(df_rank2) + ggtitle("Rank ID: 2")
p3 <- base_plot_CI(df_rank3) + ggtitle("Rank ID: 3")

# List of plots
list(p1, p2, p3)
```

