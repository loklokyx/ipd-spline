---
title: "Simulation Analysis"
author: "Lok Yiu Xuan [23171563]"
date: "`r format(Sys.Date(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(tidyr)
library(patchwork)
library(metafor)
```

# Read Simulation Data
```{r}
files <- list(
  pooled_knots3 = "../data/1800/pooled_knots3.csv", 
  meta_knots3 = "../data/1800/meta_knots3.csv",
  
  pooled_knots4 = "../data/1800/pooled_knots4.csv", 
  meta_knots4 = "../data/1800/meta_knots4.csv",
  
  pooled_knots5 = "../data/1800/pooled_knots5.csv", 
  meta_knots5 = "../data/1800/meta_knots5.csv"
)
sim_data <- lapply(files, read_csv, show_col_types = FALSE)

files2 <- list(
  pooled_knots3 = "../data/600/pooled_knots3.csv", 
  meta_knots3 = "../data/600/meta_knots3.csv",
  
  pooled_knots4 = "../data/600/pooled_knots4.csv", 
  meta_knots4 = "../data/600/meta_knots4.csv"
)
sim_data2 <- lapply(files2, read_csv, show_col_types = FALSE)
```
# Calculate Metrics Reduce df
```{r}
calculate_metrics <- function(df, level = 0.95) {
  # identify simulation columns
  sim_cols <- grep("^sim_", names(df), value = TRUE)
  Y_true <- df$Y
  
  alpha <- 1 - level
  z_val <- qnorm(1 - alpha / 2)
  
  # extract simulation matrix for easier computation
  sim_matrix <- as.matrix(df[, sim_cols])
  row_means <- rowMeans(sim_matrix)
  row_vars <- apply(sim_matrix, 1, var)
  row_mses <- rowMeans((sim_matrix - Y_true)^2)

  tibble(
    Age = df$Age,
    Y_true = Y_true,
    bias = row_means - Y_true,
    variance = row_vars,
    mse = row_mses,
    mean_pred = row_means,
    residual = Y_true - row_means,
    lower_ci = row_means - z_val * sqrt(row_vars),
    upper_ci = row_means + z_val * sqrt(row_vars)
  )
}

# Apply to all files in a list
metrics_list <- lapply(sim_data, calculate_metrics, level = 0.95)
metrics_list2 <- lapply(sim_data2, calculate_metrics, level = 0.95)

# Add method name to each element if not already
for (i in seq_along(metrics_list)) {
  metrics_list[[i]]$method <- names(metrics_list)[i]
}
for (i in seq_along(metrics_list2)) {
  metrics_list2[[i]]$method <- names(metrics_list2)[i]
}
```
# Summary of all
```{r}
set_summary <- function(df_list, 
                        metrics = c("bias", "variance", "mse"), 
                        dp = 6,
                        prefix = NULL){
  full_df <- data.frame()
  for (name in names(df_list)) {
    df <- df_list[[name]] %>%
      group_by(method) %>%
      summarise(
        across(all_of(metrics),
               list(mean = ~round(mean(.x, na.rm = TRUE), dp),
                    sd   = ~round(sd(.x, na.rm = TRUE), dp),
                    min  = ~round(min(.x), dp),
                    max  = ~round(max(.x), dp)),
               .names = "{.fn}_{.col}"),
        .groups = "drop"
      )
    if (!is.null(prefix)) {
      df <- df %>% mutate(method = paste0(method, "_", prefix))
    }
    full_df <- rbind(full_df, df)
  }
  return(full_df)
}

metrics <- c("bias", "variance", "mse")
summ <- set_summary(metrics_list, metrics = metrics, prefix = 'n1800')
summ2 <- set_summary(metrics_list2, metrics = metrics, prefix = 'n600')

combined_summary <- rbind(summ, summ2)

# reorder columns
combined_summary <- combined_summary %>%
  select(method, everything())
combined_summary
```
# Bias, Variance, MSE plot
## n=1800
### line plot
```{r, fig.height=7, fig.width=7}
df_all <- bind_rows(metrics_list) %>%
  pivot_longer(cols = c("bias", "variance", "mse"),
               names_to = "metric_name",
               values_to = "metric_value")
df_all$base_method <- word(df_all$method, 1, sep = "_")
df_all$knots <- word(df_all$method, 2, sep = "_")

ggplot(df_all, aes(x = Age, y = metric_value, color = base_method, group = method)) +
  geom_line(size = 1) +
  facet_grid(metric_name ~ knots) +
  theme_minimal() +
  labs(x = "Age", y = "Value", fill = "Base Method", color = "Method") +
  theme(
    legend.position = "bottom",
    panel.spacing = unit(1, "lines"),
    strip.background = element_rect(fill = "white")
  )
```
### CI True Value
```{r, fig.height=10, fig.width=5}
ggplot(df_all, aes(x = Age, y = mean_pred, color = base_method, fill = base_method, group = method)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.2, color = NA) +
  geom_line(aes(y = Y_true), color = "black", linetype = "dashed") +
  facet_wrap(~knots, ncol = 1, scales = "free_y") +
  theme_minimal() +
  labs(
    x = "Age",
    y = "Predicted Y",
    color = "Method",
    fill = "Method",
    title = "Predicted Values with Confidence Intervals by Knots"
  ) +
  theme(
    legend.position = "bottom",
    panel.spacing = unit(1.5, "lines"),
    strip.background = element_rect(fill = "white")
  )
```

## n=600
### line plot
```{r, fig.height=7, fig.width=7}
df_all2 <- bind_rows(metrics_list2) %>%
  pivot_longer(cols = c("bias", "variance", "mse"),
               names_to = "metric_name",
               values_to = "metric_value")
df_all2$base_method <- word(df_all2$method, 1, sep = "_")
df_all2$knots <- word(df_all2$method, 2, sep = "_")

ggplot(df_all2, aes(x = Age, y = metric_value, color = base_method, group = method)) +
  geom_line(size = 1) +
  facet_grid(metric_name ~ knots) +
  theme_minimal() +
  labs(x = "Age", y = "Value", fill = "Base Method", color = "Method") +
  theme(
    legend.position = "bottom",
    panel.spacing = unit(1, "lines"),
    strip.background = element_rect(fill = "white")
  )
```
### hist plot
```{r, fig.height=7, fig.width=5}
ggplot(df_all2, aes(x = Age, y = mean_pred, color = base_method, fill = base_method, group = method)) +
  geom_line(size = 1) +
  geom_ribbon(aes(ymin = lower_ci, ymax = upper_ci), alpha = 0.2, color = NA) +
  geom_line(aes(y = Y_true), color = "black", linetype = "dashed") +
  facet_wrap(~knots, ncol = 1, scales = "free_y") +
  theme_minimal() +
  labs(
    x = "Age",
    y = "Predicted Y",
    color = "Method",
    fill = "Method",
    title = "Predicted Values with Confidence Intervals by Knots"
  ) +
  theme(
    legend.position = "bottom",
    panel.spacing = unit(1.5, "lines"),
    strip.background = element_rect(fill = "white")
  )
```

```{r}
# getAnywhere(predict.merMod)
```

